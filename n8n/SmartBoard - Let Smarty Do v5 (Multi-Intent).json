{
  "name": "SmartBoard - Let Smarty Do v5 (Multi-Intent)",
  "nodes": [
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "smarty-agent-v5",
        "responseMode": "responseNode",
        "options": {}
      },
      "id": "webhook-trigger-v5",
      "name": "Webhook Trigger",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2,
      "position": [
        -800,
        0
      ],
      "webhookId": "smarty-agent-v5"
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "={{ $json.body.rawText }}",
        "options": {
          "systemMessage": "You are Smarty, a task automation assistant for SmartBoard. Analyze the user's request and perform the appropriate action.\n\nCURRENT CONTEXT:\n- Today: {{ $now.format('yyyy-MM-dd') }}\n- Current time: {{ $now.format('HH:mm') }}\n- User ID: {{ $json.body.user_id }}\n- Timezone: {{ $json.body.timezone || 'Asia/Kuala_Lumpur' }} (+08:00)\n\nDATE RESOLUTION (use these ACTUAL dates):\n- 'today' = {{ $now.format('yyyy-MM-dd') }}\n- 'tomorrow' = {{ $now.plus(1, 'day').format('yyyy-MM-dd') }}\n- 'next week' = {{ $now.plus(7, 'day').format('yyyy-MM-dd') }}\n\nYou can perform these actions:\n1. CREATE CALENDAR EVENT - for meetings, appointments, scheduled events\n2. CREATE TASK - for todos, tasks, assignments\n3. CREATE REMINDER - for reminders at specific times\n4. LIST TASKS - show user's current tasks\n5. LIST EVENTS - show user's upcoming calendar events\n6. MARK TASK DONE - complete a task by name\n\nRULES:\n- Always use the user_id from context: {{ $json.body.user_id }}\n- Convert relative dates (tomorrow, next week) to actual ISO-8601 timestamps with +08:00 timezone\n- For events without end_time, set end_time to 1 hour after start_time\n- For tasks without priority, default to 'medium'\n- After performing an action, respond with a confirmation message"
        }
      },
      "type": "@n8n/n8n-nodes-langchain.agent",
      "typeVersion": 1.7,
      "position": [
        -500,
        0
      ],
      "id": "ai-agent-v5",
      "name": "Smarty AI Agent"
    },
    {
      "parameters": {
        "model": "openai/gpt-oss-120b",
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatGroq",
      "typeVersion": 1,
      "position": [
        -600,
        220
      ],
      "id": "groq-model-v5",
      "name": "Groq Chat Model",
      "credentials": {
        "groqApi": {
          "id": "vusEVQGmYnv0fM5b",
          "name": "Groq account"
        }
      }
    },
    {
      "parameters": {
        "name": "create_calendar_event",
        "description": "Create a new calendar event. Use this for meetings, appointments, or scheduled events.",
        "tableId": "calendar_events",
        "fieldsUi": {
          "fieldValues": [
            {
              "fieldId": "title",
              "fieldValue": "={{ $fromAI('title', 'Event title') }}"
            },
            {
              "fieldId": "start_time",
              "fieldValue": "={{ $fromAI('start_time', 'Start time as ISO-8601 with timezone like 2026-02-07T09:00:00+08:00') }}"
            },
            {
              "fieldId": "end_time",
              "fieldValue": "={{ $fromAI('end_time', 'End time as ISO-8601 with timezone, default 1 hour after start_time') }}"
            },
            {
              "fieldId": "user_id",
              "fieldValue": "={{ $('Webhook Trigger').item.json.body.user_id }}"
            },
            {
              "fieldId": "description",
              "fieldValue": "={{ $fromAI('description', 'Optional event description', true) }}"
            }
          ]
        }
      },
      "type": "@n8n/n8n-nodes-langchain.toolSupabase",
      "typeVersion": 1,
      "position": [
        -400,
        220
      ],
      "id": "tool-create-event",
      "name": "Create Calendar Event",
      "credentials": {
        "supabaseApi": {
          "id": "t9tZXllBpQmITCOY",
          "name": "aziel supa"
        }
      }
    },
    {
      "parameters": {
        "name": "create_task",
        "description": "Create a new task or todo item. Use this for assignments, todos, or work items.",
        "tableId": "tasks",
        "fieldsUi": {
          "fieldValues": [
            {
              "fieldId": "title",
              "fieldValue": "={{ $fromAI('title', 'Task title') }}"
            },
            {
              "fieldId": "description",
              "fieldValue": "={{ $fromAI('description', 'Task description', true) }}"
            },
            {
              "fieldId": "due_date",
              "fieldValue": "={{ $fromAI('due_date', 'Due date as ISO-8601 timestamp with timezone', true) }}"
            },
            {
              "fieldId": "priority",
              "fieldValue": "={{ $fromAI('priority', 'Priority: low, medium, or high. Default medium', true) }}"
            },
            {
              "fieldId": "status",
              "fieldValue": "todo"
            },
            {
              "fieldId": "created_by",
              "fieldValue": "={{ $('Webhook Trigger').item.json.body.user_id }}"
            },
            {
              "fieldId": "user_id",
              "fieldValue": "={{ $('Webhook Trigger').item.json.body.user_id }}"
            }
          ]
        }
      },
      "type": "@n8n/n8n-nodes-langchain.toolSupabase",
      "typeVersion": 1,
      "position": [
        -280,
        220
      ],
      "id": "tool-create-task",
      "name": "Create Task",
      "credentials": {
        "supabaseApi": {
          "id": "t9tZXllBpQmITCOY",
          "name": "aziel supa"
        }
      }
    },
    {
      "parameters": {
        "name": "create_reminder",
        "description": "Create a standalone reminder for a specific time. Use this when user wants to be reminded about something.",
        "tableId": "reminders",
        "fieldsUi": {
          "fieldValues": [
            {
              "fieldId": "remind_time",
              "fieldValue": "={{ $fromAI('remind_time', 'Reminder time as ISO-8601 timestamp with timezone like 2026-02-07T15:00:00+08:00') }}"
            },
            {
              "fieldId": "status",
              "fieldValue": "pending"
            }
          ]
        }
      },
      "type": "@n8n/n8n-nodes-langchain.toolSupabase",
      "typeVersion": 1,
      "position": [
        -160,
        220
      ],
      "id": "tool-create-reminder",
      "name": "Create Reminder",
      "credentials": {
        "supabaseApi": {
          "id": "t9tZXllBpQmITCOY",
          "name": "aziel supa"
        }
      }
    },
    {
      "parameters": {
        "name": "list_my_tasks",
        "description": "List all tasks for the current user. Use when user asks to see, show, or list their tasks.",
        "operation": "getMany",
        "tableId": "tasks",
        "filterType": "manual",
        "filters": {
          "conditions": [
            {
              "keyName": "created_by",
              "condition": "eq",
              "keyValue": "={{ $('Webhook Trigger').item.json.body.user_id }}"
            }
          ]
        },
        "returnAll": true
      },
      "type": "@n8n/n8n-nodes-langchain.toolSupabase",
      "typeVersion": 1,
      "position": [
        -40,
        220
      ],
      "id": "tool-list-tasks",
      "name": "List My Tasks",
      "credentials": {
        "supabaseApi": {
          "id": "t9tZXllBpQmITCOY",
          "name": "aziel supa"
        }
      }
    },
    {
      "parameters": {
        "name": "mark_task_done",
        "description": "Mark a task as completed/done. User needs to specify the task name.",
        "operation": "update",
        "tableId": "tasks",
        "filterType": "manual",
        "filters": {
          "conditions": [
            {
              "keyName": "title",
              "condition": "ilike",
              "keyValue": "={{ $fromAI('task_name', 'The name/title of the task to mark as done') }}"
            },
            {
              "keyName": "created_by",
              "condition": "eq",
              "keyValue": "={{ $('Webhook Trigger').item.json.body.user_id }}"
            }
          ]
        },
        "fieldsUi": {
          "fieldValues": [
            {
              "fieldId": "status",
              "fieldValue": "done"
            }
          ]
        }
      },
      "type": "@n8n/n8n-nodes-langchain.toolSupabase",
      "typeVersion": 1,
      "position": [
        80,
        220
      ],
      "id": "tool-mark-done",
      "name": "Mark Task Done",
      "credentials": {
        "supabaseApi": {
          "id": "t9tZXllBpQmITCOY",
          "name": "aziel supa"
        }
      }
    },
    {
      "parameters": {
        "name": "list_calendar_events",
        "description": "List all calendar events for the current user. Use when user asks to see, show, or list their schedule or events.",
        "operation": "getMany",
        "tableId": "calendar_events",
        "filterType": "manual",
        "filters": {
          "conditions": [
            {
              "keyName": "user_id",
              "condition": "eq",
              "keyValue": "={{ $('Webhook Trigger').item.json.body.user_id }}"
            }
          ]
        },
        "returnAll": true
      },
      "type": "@n8n/n8n-nodes-langchain.toolSupabase",
      "typeVersion": 1,
      "position": [
        200,
        220
      ],
      "id": "tool-list-events",
      "name": "List My Events",
      "credentials": {
        "supabaseApi": {
          "id": "t9tZXllBpQmITCOY",
          "name": "aziel supa"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// Format response with action-specific messages\nconst agentOutput = $input.first().json;\nconst output = agentOutput.output || '';\nconst toolCalls = agentOutput.intermediateSteps || [];\n\nlet actionType = 'general';\nlet summary = output;\nlet details = {};\n\n// Parse tool calls to determine action type and build better messages\nif (toolCalls.length > 0) {\n  const lastStep = toolCalls[toolCalls.length - 1];\n  const toolName = lastStep.action?.tool || lastStep.action || '';\n  const observation = lastStep.observation;\n  \n  // Try to parse observation as JSON\n  try {\n    if (typeof observation === 'string') {\n      details = JSON.parse(observation);\n    } else {\n      details = observation || {};\n    }\n  } catch (e) {\n    details = { raw: observation };\n  }\n  \n  // Generate action-specific summary\n  switch(toolName) {\n    case 'create_calendar_event':\n      actionType = 'calendar_event_created';\n      if (details.title) {\n        const startDate = details.start_time ? new Date(details.start_time).toLocaleString('en-US', { timeZone: 'Asia/Kuala_Lumpur' }) : '';\n        summary = `âœ… Created event \"${details.title}\"${startDate ? ` scheduled for ${startDate}` : ''}`;\n      }\n      break;\n      \n    case 'create_task':\n      actionType = 'task_created';\n      if (details.title) {\n        const dueInfo = details.due_date ? ` (due ${new Date(details.due_date).toLocaleDateString()})` : '';\n        const priorityInfo = details.priority ? ` [${details.priority} priority]` : '';\n        summary = `âœ… Created task \"${details.title}\"${dueInfo}${priorityInfo}`;\n      }\n      break;\n      \n    case 'create_reminder':\n      actionType = 'reminder_created';\n      if (details.remind_time) {\n        const remindDate = new Date(details.remind_time).toLocaleString('en-US', { timeZone: 'Asia/Kuala_Lumpur' });\n        summary = `â° Reminder set for ${remindDate}`;\n      }\n      break;\n      \n    case 'list_my_tasks':\n      actionType = 'tasks_listed';\n      const tasks = Array.isArray(details) ? details : (details.data || []);\n      if (tasks.length > 0) {\n        const taskList = tasks.slice(0, 10).map(t => `â€¢ ${t.title} (${t.status})`).join('\\n');\n        summary = `ðŸ“‹ You have ${tasks.length} task(s):\\n${taskList}`;\n        if (tasks.length > 10) summary += `\\n... and ${tasks.length - 10} more`;\n      } else {\n        summary = 'ðŸ“‹ You have no tasks yet. Create one with \"Create task [name]\"';\n      }\n      details = { count: tasks.length, tasks: tasks.slice(0, 10) };\n      break;\n\n    case 'list_calendar_events':\n      actionType = 'events_listed';\n      const events = Array.isArray(details) ? details : (details.data || []);\n      if (events.length > 0) {\n        const eventList = events.slice(0, 5).map(e => `â€¢ ${e.title} (${new Date(e.start_time).toLocaleString('en-US', { month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' })})`).join('\\n');\n        summary = `ðŸ“… You have ${events.length} upcoming event(s):\\n${eventList}`;\n        if (events.length > 5) summary += `\\n... and ${events.length - 5} more`;\n      } else {\n        summary = 'ðŸ“… You have no upcoming events. Create one with \"Create event [title]\"';\n      }\n      details = { count: events.length, events: events.slice(0, 5) };\n      break;\n      \n    case 'mark_task_done':\n      actionType = 'task_completed';\n      if (details.title) {\n        summary = `âœ… Marked \"${details.title}\" as done! Great job! ðŸŽ‰`;\n      } else {\n        summary = output || 'âœ… Task marked as done!';\n      }\n      break;\n      \n    default:\n      summary = output || 'Action completed successfully.';\n  }\n}\n\nreturn [{\n  json: {\n    success: true,\n    executed: true,\n    action_type: actionType,\n    summary: summary,\n    details: details,\n    tool_calls_count: toolCalls.length,\n    timestamp: new Date().toISOString()\n  }\n}];"
      },
      "id": "format-response-v5",
      "name": "Format Response",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        300,
        0
      ]
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{ $json }}",
        "options": {
          "responseCode": 200
        }
      },
      "id": "respond-webhook-v5",
      "name": "Respond to Webhook",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.1,
      "position": [
        520,
        0
      ]
    }
  ],
  "connections": {
    "Webhook Trigger": {
      "main": [
        [
          {
            "node": "Smarty AI Agent",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Smarty AI Agent": {
      "main": [
        [
          {
            "node": "Format Response",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Groq Chat Model": {
      "ai_languageModel": [
        [
          {
            "node": "Smarty AI Agent",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "Create Calendar Event": {
      "ai_tool": [
        [
          {
            "node": "Smarty AI Agent",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Create Task": {
      "ai_tool": [
        [
          {
            "node": "Smarty AI Agent",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Create Reminder": {
      "ai_tool": [
        [
          {
            "node": "Smarty AI Agent",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "List My Tasks": {
      "ai_tool": [
        [
          {
            "node": "Smarty AI Agent",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Mark Task Done": {
      "ai_tool": [
        [
          {
            "node": "Smarty AI Agent",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "List My Events": {
      "ai_tool": [
        [
          {
            "node": "Smarty AI Agent",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Format Response": {
      "main": [
        [
          {
            "node": "Respond to Webhook",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "pinData": {},
  "settings": {
    "executionOrder": "v1"
  },
  "meta": {
    "templateCredsSetupCompleted": true,
    "instanceId": "398f23e3acc16d327f5c45cd47b94faa8a99cc1090fbefa83f4ca66ed493efe3"
  },
  "tags": []
}